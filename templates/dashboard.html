{% extends "base.html" %}

{% block title %}HERA Dashboard{% endblock %}
{% block page_title %}Dashboard Overview{% endblock %}

{% block styles %}
<link href="{{ url_for('static', filename='css/dashboard.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<!-- Enhanced Countdown Display -->
<div class="countdown-display">
    <h2 class="countdown-title">Until The Big Trip</h2>
    <div class="countdown-numbers">
        <div class="countdown-unit">
            <span class="countdown-value" id="countdown-days-large">{{ days_until }}</span>
            <span class="countdown-label">Days</span>
        </div>
        <div class="countdown-unit">
            <span class="countdown-value" id="countdown-hours">0</span>
            <span class="countdown-label">Hours</span>
        </div>
        <div class="countdown-unit">
            <span class="countdown-value" id="countdown-minutes">0</span>
            <span class="countdown-label">Minutes</span>
        </div>
    </div>
    <div class="trip-dates">September 24-29, 2025 • Banff, Alberta</div>
</div>

<!-- Stats Grid -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-number">${{ "{:,.0f}".format(budget_stats.total_saved) }}</div>
        <div class="stat-label">Budget Saved</div>
        <div class="stat-sublabel">${{ "{:,.0f}".format(budget_stats.total_remaining) }} remaining</div>
    </div>

    <div class="stat-card">
        <div class="stat-number">{{ completed_tasks|length }}/{{ total_tasks }}</div>
        <div class="stat-label">Tasks Complete</div>
        <div class="stat-sublabel">{{ total_tasks - completed_tasks|length }} remaining</div>
    </div>

    <div class="stat-card">
        <div class="stat-number">{{ approved_family }}/{{ total_family }}</div>
        <div class="stat-label">Family Approved</div>
        <div class="stat-sublabel">{{ total_family - approved_family }} pending</div>
    </div>

    <div class="stat-card">
        <div class="stat-number">{{ packed_items }}/{{ total_items }}</div>
        <div class="stat-label">Packing Progress</div>
        <div class="stat-sublabel">{{ total_items - packed_items }} items left</div>
    </div>
</div>

<!-- Content Grid -->
<div class="content-grid">
    <!-- Task Progress (Main Focus) -->
    <div class="widget widget-large">
        <div class="widget-header">
            <div>
                <h3 class="widget-title">
                    <i class="fas fa-tasks"></i>
                    Project Tasks
                </h3>
                <p class="widget-subtitle">{{ completed_tasks|length }} of {{ total_tasks }} completed</p>
            </div>
            <div class="widget-actions">
                <button class="btn btn-primary btn-sm" onclick="showAddTaskModal()">
                    <i class="fas fa-plus"></i>
                    Add Task
                </button>
            </div>
        </div>

        <div class="widget-content">
            <!-- PROGRESS BAR REMOVED - Only showing task completion status as text -->
            <div class="task-completion-summary">
                <div class="completion-text">{{ "%.0f"|format(task_progress) }}% Complete ({{ completed_tasks|length }}/{{ total_tasks }} tasks)</div>
            </div>

            <div class="task-items">
                {% for task in HERA_DATA.main.tasks %}
                <div class="task-item {% if 'Complete' in task.status %}completed{% endif %}" data-task-id="{{ task.id }}">
                    <div class="task-checkbox">
                        <input type="checkbox"
                               id="task-{{ task.id }}"
                               data-task-id="{{ task.id }}"
                               {% if 'Complete' in task.status %} checked{% endif %}
                               onchange="toggleTaskStatus({{ task.id }})">
                        <label for="task-{{ task.id }}"></label>
                    </div>

                    <div class="task-info">
                        <div class="task-name">{{ task.task }}</div>
                        <div class="task-details">
                            <span class="task-deadline">Due: {{ task.deadline }}</span>
                            <span class="task-status status-{{ task.status.lower().replace(' ', '-').replace(',', '') }}">
                                {{ task.status }}
                            </span>
                        </div>
                        {% if task.notes %}
                        <div class="task-notes">{{ task.notes }}</div>
                        {% endif %}
                    </div>

                    <div class="task-actions">
                        <button class="task-action-btn edit" onclick="editTask({{ task.id }})" title="Edit Task">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="task-action-btn delete" onclick="deleteTask({{ task.id }})" title="Delete Task">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Budget Summary -->
    <div class="widget">
        <div class="widget-header">
            <div>
                <h3 class="widget-title">
                    <i class="fas fa-wallet"></i>
                    Budget Overview
                </h3>
                <p class="widget-subtitle">${{ "{:,.0f}".format(budget_stats.total_budget) }} total budget</p>
            </div>
            <div class="widget-actions">
                <a href="{{ url_for('budget') }}" class="btn btn-secondary btn-sm">
                    <i class="fas fa-eye"></i>
                    View All
                </a>
            </div>
        </div>

        <div class="widget-content">
            <div class="budget-summary-compact">
                <div class="budget-label">Amount Saved</div>
                <div class="budget-amount-large">${{ "{:,.0f}".format(budget_stats.total_saved) }}</div>
                <div class="budget-stats-text">
                    ${{ "{:,.0f}".format(budget_stats.total_remaining) }} remaining • {{ "%.1f"|format(budget_stats.budget_progress) }}% saved
                </div>
                <!-- PROGRESS BAR REMOVED - Budget progress shown as text only -->
            </div>

            <!-- Top 3 Budget Items Only -->
            <div class="budget-items-preview">
                {% for item in top_budget_items[:3] %}
                <div class="budget-item-compact" data-budget-id="{{ item.id }}">
                    <div class="budget-info">
                        <span class="budget-name">{{ item.category }}</span>
                        <span class="budget-status-badge status-{{ item.status.lower() }}">
                            {{ item.status }}
                        </span>
                    </div>
                    <div class="budget-amount">${{ "{:,.0f}".format(item.budget) }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Family Approval -->
    <div class="widget">
        <div class="widget-header">
            <div>
                <h3 class="widget-title">
                    <i class="fas fa-users"></i>
                    Family Approval
                </h3>
                <p class="widget-subtitle">{{ approved_family }} of {{ total_family }} approved</p>
            </div>
            <div class="widget-actions">
                <a href="{{ url_for('family') }}" class="btn btn-secondary btn-sm">
                    <i class="fas fa-eye"></i>
                    View All
                </a>
            </div>
        </div>

        <div class="widget-content">
            <!-- PROGRESS BAR REMOVED - Family approval shown as summary text -->
            <div class="family-approval-summary">
                <div class="approval-text">
                    {% set family_progress = (approved_family / total_family * 100) if total_family > 0 else 0 %}
                    {{ "%.0f"|format(family_progress) }}% Approved ({{ approved_family }}/{{ total_family }} family members)
                </div>
            </div>

            <div class="family-grid">
                {% for member in HERA_DATA.family[:4] %}
                <div class="family-member">
                    <div class="member-avatar">
                        {{ member.name[0] }}
                    </div>
                    <div class="member-info">
                        <div class="member-name">{{ member.name }}</div>
                        <div class="member-status status-{{ member.status.lower() }}">
                            {{ member.status }}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Packing -->
    <!-- <div class="widget">
        <div class="widget-header">
            <div>
                <h3 class="widget-title">
                    <i class="fas fa-suitcase"></i>
                    Packing List
                </h3>
                <p class="widget-subtitle">{{ packed_items }} of {{ total_items }} packed</p>
            </div>
            <div class="widget-actions">
                <a href="{{ url_for('packing') }}" class="btn btn-secondary btn-sm">
                    <i class="fas fa-eye"></i>
                    View All
                </a>
            </div>
        </div>

        <div class="widget-content">
            PROGRESS BAR REMOVED - Packing progress shown as summary text
            <div class="packing-summary">
                <div class="packing-stats">
                    {% set packing_progress = (packed_items / total_items * 100) if total_items > 0 else 0 %}
                    {{ "%.0f"|format(packing_progress) }}% Packed • {{ packed_items }}/{{ total_items }} items complete
                </div>
                <div class="packing-reminder">{{ total_items - packed_items }} items remaining</div>
            </div>

            <div class="packing-categories">
                {% set categories = HERA_DATA.packing | groupby('category') %}
                {% for category, items in categories %}
                <div class="category-summary">
                    <span class="category-name">{{ category }}</span>
                    <span class="category-count">{{ items | selectattr('packed') | list | length }}/{{ items | list | length }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    Recent Activity -->
    <!--<div class="widget">
        <div class="widget-header">
            <div>
                <h3 class="widget-title">
                    <i class="fas fa-clock"></i>
                    Recent Activity
                </h3>
            </div>
        </div>

        <div class="widget-content">
            <div class="activity-list">
                <div class="activity-item">
                    <div class="activity-icon completed">
                        <i class="fas fa-check"></i>
                    </div>
                    <div class="activity-details">
                        <div class="activity-text">Flights booked successfully</div>
                        <div class="activity-time">2 days ago</div>
                    </div>
                </div>

                <div class="activity-item">
                    <div class="activity-icon completed">
                        <i class="fas fa-check"></i>
                    </div>
                    <div class="activity-details">
                        <div class="activity-text">Family permissions obtained</div>
                        <div class="activity-time">1 week ago</div>
                    </div>
                </div>

                <div class="activity-item">
                    <div class="activity-icon completed">
                        <i class="fas fa-gem"></i>
                    </div>
                    <div class="activity-details">
                        <div class="activity-text">Ring completed and picked up</div>
                        <div class="activity-time">2 weeks ago</div>
                    </div>
                </div>
            </div>
        </div>
    </div> -->
</div>

<!-- Quick Actions Grid -->
<div class="quick-actions">
    <div class="action-card" onclick="window.location.href='{{ url_for('budget') }}'">
        <div class="action-icon">
            <i class="fas fa-wallet"></i>
        </div>
        <div class="action-title">Manage Budget</div>
        <div class="action-subtitle">Track expenses</div>
    </div>

    <div class="action-card" onclick="window.location.href='{{ url_for('family') }}'">
        <div class="action-icon">
            <i class="fas fa-users"></i>
        </div>
        <div class="action-title">Family Status</div>
        <div class="action-subtitle">Check approvals</div>
    </div>

    <div class="action-card" onclick="window.location.href='{{ url_for('packing') }}'">
        <div class="action-icon">
            <i class="fas fa-suitcase"></i>
        </div>
        <div class="action-title">Packing List</div>
        <div class="action-subtitle">Prepare for trip</div>
    </div>

    <div class="action-card" onclick="window.location.href='{{ url_for('itinerary') }}'">
        <div class="action-icon">
            <i class="fas fa-map-marked-alt"></i>
        </div>
        <div class="action-title">Trip Itinerary</div>
        <div class="action-subtitle">Plan activities</div>
    </div>
</div>

<!-- Add any modals or additional content here -->

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script>
    // Initialize dashboard without progress bar animations
    document.addEventListener('DOMContentLoaded', function() {
        // Start countdown timer
        // updateCountdown();
        // setInterval(updateCountdown, 60000); // Update every minute

        // Setup keyboard shortcuts
        setupKeyboardShortcuts();

        // Animate stat numbers counting up (keeping this animation)
        animateStatNumbers();

        // Remove progress bar specific animations
        console.log('Dashboard loaded without progress bars');
    });

    function updateCountdown() {
        const proposalDate = new Date('2025-09-24T00:00:00');
        const now = new Date();
        const diff = proposalDate - now;

        if (diff > 0) {
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

            document.getElementById('countdown-days-large').textContent = days;
            document.getElementById('countdown-hours').textContent = hours;
            document.getElementById('countdown-minutes').textContent = minutes;
        }
    }

    function animateStatNumbers() {
        const statNumbers = document.querySelectorAll('.stat-number');
        statNumbers.forEach(stat => {
            const text = stat.textContent;
            // Only animate pure numbers, not text with slashes or symbols
            if (/^\d+$/.test(text)) {
                const finalValue = parseInt(text);
                animateNumber(stat, 0, finalValue, 1000);
            }
        });
    }

    function animateNumber(element, start, end, duration) {
        const range = end - start;
        const increment = range / (duration / 16); // 60fps
        let current = start;

        const timer = setInterval(() => {
            current += increment;
            if (current >= end) {
                current = end;
                clearInterval(timer);
            }
            element.textContent = Math.floor(current);
        }, 16);
    }

    // DEBUG: Add this to dashboard.html temporarily
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== COUNTDOWN DEBUG ===');

    // Check what's in the countdown element
    const countdownElement = document.getElementById('countdown-text');
    console.log('Countdown element:', countdownElement);
    console.log('Initial countdown text:', countdownElement ? countdownElement.textContent : 'NOT FOUND');

    // Check if base.js updateCountdown is working
    if (window.HERA && window.HERA.updateCountdown) {
        console.log('Base.js updateCountdown found');
        window.HERA.updateCountdown();
        console.log('After base updateCountdown:', countdownElement ? countdownElement.textContent : 'NOT FOUND');
    } else {
        console.log('Base.js updateCountdown NOT FOUND');
    }

    // Check for countdown.js interference
    setTimeout(() => {
        console.log('Countdown text after 2 seconds:', countdownElement ? countdownElement.textContent : 'NOT FOUND');
    }, 2000);

    // Check which scripts are loaded
    const scripts = Array.from(document.getElementsByTagName('script'));
    console.log('Loaded scripts:', scripts.map(s => s.src || 'inline'));

    // Check for multiple countdown functions
    console.log('Global updateCountdown function:', typeof window.updateCountdown);
    console.log('HERA updateCountdown function:', typeof window.HERA?.updateCountdown);
});

</script>
{% endblock %}