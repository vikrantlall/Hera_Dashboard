{% extends "base.html" %}

{% block title %}HERA Dashboard{% endblock %}

{% block page_title %}Dashboard Overview{% endblock %}

{% block styles %}
<link href="{{ url_for('static', filename='css/dashboard.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<!-- Hero Statistics -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-number" id="countdown-days">{{ days_until }}</div>
        <div class="stat-label">Days Until</div>
        <div class="stat-sublabel">September 24, 2025</div>
    </div>

    <div class="stat-card">
        <div class="stat-number">${{ "{:,.0f}".format(budget_stats.total_saved) }}</div>
        <div class="stat-label">Budget Saved</div>
        <div class="stat-sublabel">${{ "{:,.0f}".format(budget_stats.total_saved) }} of ${{ "{:,.0f}".format(budget_stats.total_budget) }}</div>
    </div>

    <div class="stat-card">
        {% set completed_tasks = [] %}
        {% for task in HERA_DATA.main.tasks %}
            {% if 'Complete' in task.status %}
                {% set _ = completed_tasks.append(task) %}
            {% endif %}
        {% endfor %}
        <div class="stat-number">{{ completed_tasks|length }}/{{ HERA_DATA.main.tasks|length }}</div>
        <div class="stat-label">Tasks Complete</div>
        <div class="stat-sublabel">{{ HERA_DATA.main.tasks|length - completed_tasks|length }} remaining</div>
    </div>

    <div class="stat-card">
        <div class="stat-number">{{ approved_family }}/{{ total_family }}</div>
        <div class="stat-label">Family Approved</div>
        <div class="stat-sublabel">{{ total_family - approved_family }} pending</div>
    </div>
</div>

<!-- Content Grid -->
<div class="content-grid">
    <!-- Budget Progress -->
    <div class="widget">
        <div class="widget-header">
            <div>
                <h3 class="widget-title">Budget Progress</h3>
                <p class="widget-subtitle">${{ "{:,.0f}".format(budget_stats.total_saved) }} saved of ${{ "{:,.0f}".format(budget_stats.total_budget) }} total</p>
            </div>
            <div class="widget-actions">
                <button class="action-btn add-btn" onclick="openAddBudgetModal()" data-tooltip="Add Budget Item">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>

        <div class="budget-items">
            {% for item in top_budget_items %}
            <div class="budget-item" data-item-id="{{ item.id }}">
                <div class="budget-info">
                    <div class="budget-name">{{ item.category }}</div>
                    <div class="budget-amount">${{ "{:,.0f}".format(item.saved) }} / ${{ "{:,.0f}".format(item.budget) }}</div>
                </div>
                <div class="budget-progress">
                    <div class="progress-bar">
                        {% set progress = (item.saved / item.budget * 100) if item.budget > 0 else 0 %}
                        {% set progress_class = '' if item.status == 'Paid' else 'pending' %}
                        <div class="progress-fill {{ progress_class }}" style="width: {{ progress }}%"></div>
                    </div>
                </div>
                <div class="budget-status">
                    <span class="status-badge {{ 'paid' if item.status == 'Paid' else 'outstanding' }}">{{ item.status }}</span>
                </div>
                <div class="budget-actions">
                    <button class="action-btn edit-btn" onclick="openBudgetModal({{ item.id }})" data-tooltip="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="action-btn delete-btn" onclick="deleteBudgetItem({{ item.id }})" data-tooltip="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Right Column -->
    <div>
        <!-- Countdown Widget -->
        <div class="countdown-display">
            <h3 class="countdown-title">Proposal Trip Countdown</h3>
            <div class="countdown-numbers">
                <div class="countdown-unit">
                    <span class="countdown-value" id="countdown-days-large">{{ days_until }}</span>
                    <div class="countdown-label">Days</div>
                </div>
                <div class="countdown-unit">
                    <span class="countdown-value" id="countdown-hours">0</span>
                    <div class="countdown-label">Hours</div>
                </div>
                <div class="countdown-unit">
                    <span class="countdown-value" id="countdown-minutes">0</span>
                    <div class="countdown-label">Minutes</div>
                </div>
            </div>
            <div class="trip-dates">{{ HERA_DATA.main.tripDates }} â€¢ Banff, Canada</div>
        </div>

        <!-- Task Status -->
        <div class="widget">
            <div class="widget-header">
                <h3 class="widget-title">Remaining Tasks</h3>
                {% set pending_tasks = [] %}
                {% for task in HERA_DATA.main.tasks %}
                    {% if 'Complete' not in task.status %}
                        {% set _ = pending_tasks.append(task) %}
                    {% endif %}
                {% endfor %}
                <p class="widget-subtitle">{{ pending_tasks|length }} of {{ HERA_DATA.main.tasks|length }} tasks pending</p>
            </div>

            <div class="task-items">
                {% for task in pending_tasks[:3] %}
                <div class="task-item" data-task-id="{{ task.id }}">
                    <div class="task-checkbox {{ 'completed' if 'Complete' in task.status else '' }}">
                        {% if 'Complete' in task.status %}
                        <i class="fas fa-check"></i>
                        {% endif %}
                    </div>
                    <div class="task-content">
                        <div class="task-name {{ 'completed' if 'Complete' in task.status else '' }}">{{ task.task }}</div>
                        <div class="task-deadline">Due: {{ task.deadline }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Family Status -->
        <div class="widget">
            <div class="widget-header">
                <h3 class="widget-title">Family Permissions</h3>
                <p class="widget-subtitle">{{ approved_family }} approved, {{ total_family - approved_family }} pending</p>
            </div>

            <div class="family-grid">
                {% for member in HERA_DATA.family[:3] %}
                <div class="family-member">
                    {% set avatar_color = 'var(--success)' if member.status == 'Approved' else 'var(--warning)' %}
                    <div class="member-avatar" style="background: {{ avatar_color }};">{{ member.name[0] }}</div>
                    <div class="member-name">{{ member.name }}</div>
                    <div class="status-badge {{ 'approved' if member.status == 'Approved' else 'pending' }}">{{ member.status }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Budget Modal -->
<div id="budget-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="budget-modal-title">Edit Budget Item</h3>
            <button class="modal-close" onclick="closeBudgetModal()">&times;</button>
        </div>
        <form id="budget-form">
            <div class="modal-body">
                <input type="hidden" id="budget-item-id">

                <div class="form-group">
                    <label class="form-label">Category</label>
                    <input type="text" class="form-input" id="budget-category" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Budget Amount</label>
                        <div class="currency-input">
                            <input type="number" class="form-input" id="budget-amount" step="0.01" min="0" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Amount Saved</label>
                        <div class="currency-input">
                            <input type="number" class="form-input" id="budget-saved" step="0.01" min="0">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="budget-status">
                        <option value="Outstanding">Outstanding</option>
                        <option value="Paid">Paid</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-textarea" id="budget-notes" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeBudgetModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Add Budget Modal -->
<div id="add-budget-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Add Budget Item</h3>
            <button class="modal-close" onclick="closeAddBudgetModal()">&times;</button>
        </div>
        <form id="add-budget-form">
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <input type="text" class="form-input" id="add-budget-category" required placeholder="e.g., Entertainment, Food, etc.">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Budget Amount</label>
                        <div class="currency-input">
                            <input type="number" class="form-input" id="add-budget-amount" step="0.01" min="0" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Amount Saved</label>
                        <div class="currency-input">
                            <input type="number" class="form-input" id="add-budget-saved" step="0.01" min="0" value="0">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="add-budget-status">
                        <option value="Outstanding">Outstanding</option>
                        <option value="Paid">Paid</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-textarea" id="add-budget-notes" rows="3" placeholder="Any additional details..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeAddBudgetModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-plus"></i>
                    Add Item
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script>
    // Pass data to JavaScript - using your exact Flask variables
    window.HERA_DATA = {
        budget: {{ top_budget_items | tojson }},
        tasks: {{ HERA_DATA.main.tasks | tojson }},
        family: {{ HERA_DATA.family | tojson }},
        budgetStats: {{ budget_stats | tojson }}
    };

    // Modal functions - simple implementations
    function openBudgetModal(budgetId) {
        const item = window.HERA_DATA.budget.find(b => b.id === budgetId);
        if (item) {
            document.getElementById('budget-item-id').value = item.id;
            document.getElementById('budget-category').value = item.category;
            document.getElementById('budget-amount').value = item.budget;
            document.getElementById('budget-saved').value = item.saved;
            document.getElementById('budget-status').value = item.status;
            document.getElementById('budget-notes').value = item.notes || '';
            document.getElementById('budget-modal').classList.add('show');
        }
    }

    function closeBudgetModal() {
        document.getElementById('budget-modal').classList.remove('show');
    }

    function openAddBudgetModal() {
        document.getElementById('add-budget-form').reset();
        document.getElementById('add-budget-modal').classList.add('show');
    }

    function closeAddBudgetModal() {
        document.getElementById('add-budget-modal').classList.remove('show');
    }

    function deleteBudgetItem(budgetId) {
        if (confirm('Are you sure you want to delete this budget item?')) {
            console.log('Delete budget item:', budgetId);
            // TODO: Implement delete API call
        }
    }

    // Close modals when clicking outside
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal')) {
            e.target.classList.remove('show');
        }
    });
</script>
{% endblock %}