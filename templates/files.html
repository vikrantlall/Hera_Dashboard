{% extends "base.html" %}

{% block title %}Files - HERA{% endblock %}
{% block page_title %}Trip Documents{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/files.css') }}">
{% endblock %}

{% block content %}
<div class="files-container">
    <!-- Upload Section -->
    <div class="upload-section">
        <div class="widget">
            <div class="widget-header">
                <h3 class="widget-title">
                    <i class="fas fa-cloud-upload-alt"></i>
                    Upload Documents
                </h3>
                <button class="btn btn-primary" onclick="openUploadModal()">
                    <i class="fas fa-plus"></i>
                    Add Files
                </button>
            </div>
            
            <div class="upload-drop-zone" id="file-drop-zone">
                <div class="upload-icon">
                    <i class="fas fa-file-upload"></i>
                </div>
                <div class="upload-text">
                    <h4>Drag & Drop Files Here</h4>
                    <p>Or click to browse and upload trip documents</p>
                    <button class="btn btn-secondary" onclick="document.getElementById('file-upload-input').click()">
                        <i class="fas fa-folder-open"></i>
                        Browse Files
                    </button>
                </div>
                <div class="upload-info">
                    <span>Supports: PDF, DOC, DOCX, JPG, PNG, TXT</span>
                    <span>Max file size: 25MB</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Files Overview Stats -->
    <div class="files-stats">
        <div class="stat-card">
            <div class="stat-icon documents">
                <i class="fas fa-file-alt"></i>
            </div>
            <div class="stat-info">
                <div class="stat-number" id="total-files">{{ files|length if files else 0 }}</div>
                <div class="stat-label">Total Files</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon size">
                <i class="fas fa-hdd"></i>
            </div>
            <div class="stat-info">
                <div class="stat-number" id="total-size">{{ total_size or '0 MB' }}</div>
                <div class="stat-label">Storage Used</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon categories">
                <i class="fas fa-layer-group"></i>
            </div>
            <div class="stat-info">
                <div class="stat-number" id="total-categories">{{ categories|length if categories else 0 }}</div>
                <div class="stat-label">Categories</div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon recent">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-info">
                <div class="stat-number" id="recent-uploads">{{ recent_count or 0 }}</div>
                <div class="stat-label">Recent Uploads</div>
            </div>
        </div>
    </div>

    <!-- Category Filters -->
    <div class="filter-section">
        <div class="category-filters">
            <button class="category-filter active" data-category="all">
                <i class="fas fa-th-large"></i>
                All Files <span class="count">{{ files|length if files else 0 }}</span>
            </button>
            
            <button class="category-filter" data-category="travel">
                <i class="fas fa-plane"></i>
                Travel Documents <span class="count">{{ travel_docs_count or 0 }}</span>
            </button>
            
            <button class="category-filter" data-category="reservations">
                <i class="fas fa-calendar-check"></i>
                Reservations <span class="count">{{ reservations_count or 0 }}</span>
            </button>
            
            <button class="category-filter" data-category="photos">
                <i class="fas fa-images"></i>
                Photos <span class="count">{{ photos_count or 0 }}</span>
            </button>
            
            <button class="category-filter" data-category="documents">
                <i class="fas fa-file-alt"></i>
                Documents <span class="count">{{ documents_count or 0 }}</span>
            </button>
            
            <button class="category-filter" data-category="other">
                <i class="fas fa-folder"></i>
                Other <span class="count">{{ other_count or 0 }}</span>
            </button>
        </div>
        
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" placeholder="Search files..." id="file-search">
        </div>
    </div>

    <!-- Files Grid -->
    <div class="files-grid" id="files-grid">
        {% if files and files|length > 0 %}
            {% for file in files %}
            <div class="file-card" data-category="{{ file.category }}" data-file-id="{{ file.id }}">
                <div class="file-preview">
                    {% if file.type == 'image' %}
                        <img src="{{ url_for('static', filename='uploads/files/' + file.filename) }}" alt="{{ file.original_name }}" class="file-thumbnail">
                    {% elif file.type == 'pdf' %}
                        <div class="file-icon pdf">
                            <i class="fas fa-file-pdf"></i>
                        </div>
                    {% elif file.type == 'document' %}
                        <div class="file-icon document">
                            <i class="fas fa-file-word"></i>
                        </div>
                    {% else %}
                        <div class="file-icon general">
                            <i class="fas fa-file"></i>
                        </div>
                    {% endif %}
                </div>
                
                <div class="file-info">
                    <div class="file-name" title="{{ file.original_name }}">
                        {{ file.original_name }}
                    </div>
                    <div class="file-details">
                        <span class="file-size">{{ file.size }}</span>
                        <span class="file-date">{{ file.upload_date.strftime('%b %d, %Y') if file.upload_date else 'Unknown' }}</span>
                    </div>
                    <div class="file-category">
                        <span class="category-badge category-{{ file.category }}">
                            {{ file.category.title() }}
                        </span>
                    </div>
                </div>
                
                <div class="file-actions">
                    <button class="action-btn download-btn" onclick="downloadFile('{{ file.filename }}')" title="Download">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="action-btn view-btn" onclick="viewFile('{{ file.filename }}', '{{ file.type }}')" title="View">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="action-btn edit-btn" onclick="editFile({{ file.id }})" title="Edit Details">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="action-btn delete-btn" onclick="deleteFile({{ file.id }}, '{{ file.original_name }}')" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="fas fa-folder-open"></i>
                </div>
                <h3>No Documents Yet</h3>
                <p>Upload your first trip document to get started</p>
                <button class="btn btn-primary" onclick="openUploadModal()">
                    <i class="fas fa-cloud-upload-alt"></i>
                    Upload Files
                </button>
            </div>
        {% endif %}
    </div>
</div>

<!-- Hidden file input -->
<input type="file" id="file-upload-input" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.txt,.zip,.xlsx,.xls" multiple style="display: none;">

<!-- Upload Modal -->
<div id="upload-modal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3 class="modal-title">Upload Files</h3>
            <button class="modal-close" onclick="closeUploadModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="upload-area" id="modal-drop-zone">
                <i class="fas fa-cloud-upload-alt"></i>
                <p>Drag & drop files here or click to browse</p>
                <button type="button" class="btn btn-primary" onclick="document.getElementById('file-upload-input').click()">
                    <i class="fas fa-folder-open"></i>
                    Choose Files
                </button>
            </div>

            <div class="file-list" id="upload-file-list" style="display: none;">
                <h4>Files to Upload</h4>
                <div class="upload-files" id="upload-files-container"></div>
            </div>

            <div class="upload-progress" id="upload-progress" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <p id="progress-text">Uploading files...</p>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeUploadModal()">Cancel</button>
            <button type="button" class="btn btn-primary" id="upload-files-btn" onclick="uploadFiles()" style="display: none;">
                <i class="fas fa-upload"></i>
                Upload Files
            </button>
        </div>
    </div>
</div>

<!-- File Edit Modal -->
<div id="edit-file-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Edit File Details</h3>
            <button class="modal-close" onclick="closeEditModal()">&times;</button>
        </div>
        <form class="modal-body" id="edit-file-form">
            <div class="form-group">
                <label class="form-label">File Name</label>
                <input type="text" class="form-input" id="edit-file-name" placeholder="Enter file name">
            </div>
            
            <div class="form-group">
                <label class="form-label">Category</label>
                <select class="form-select" id="edit-file-category">
                    <option value="travel">Travel Documents</option>
                    <option value="reservations">Reservations</option>
                    <option value="photos">Photos</option>
                    <option value="documents">Documents</option>
                    <option value="other">Other</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Notes</label>
                <textarea class="form-textarea" id="edit-file-notes" rows="3" placeholder="Add any notes about this file..."></textarea>
            </div>
        </form>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
            <button type="submit" form="edit-file-form" class="btn btn-primary">
                <i class="fas fa-save"></i>
                Save Changes
            </button>
        </div>
    </div>
</div>

<!-- File Viewer Modal -->
<div id="file-viewer-modal" class="modal modal-fullscreen">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="viewer-title">File Viewer</h3>
            <button class="modal-close" onclick="closeViewerModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="file-viewer-content">
                <!-- File content will be loaded here -->
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeViewerModal()">Close</button>
            <button type="button" class="btn btn-primary" id="download-from-viewer">
                <i class="fas fa-download"></i>
                Download
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/files.js') }}"></script>
<script>
    // Pass Flask data to JavaScript
    window.FILES_DATA = {{ files | tojson if files else [] }};

    // Initialize files page functionality
    document.addEventListener('DOMContentLoaded', function() {
        initializeFilesPage();
    });
</script>
{% endblock %}