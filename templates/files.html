{% extends "base.html" %}

{% block title %}Files - HERA{% endblock %}
{% block page_title %}Trip Documents{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/files.css') }}">
{% endblock %}

{% block content %}
<div class="files-container">
    <!-- Hidden file input with video support -->
    <input type="file" id="file-upload-input" multiple accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.gif,.webp,.zip,.xlsx,.xls,.mov,.mp4,.avi,.mkv,.webm" style="display: none;">

    <!-- Stats Grid - Following dashboard pattern -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number" id="total-files">{{ files|length if files else 0 }}</div>
            <div class="stat-label">Total Files</div>
            <div class="stat-sublabel">{{ total_size or '0 B' }}</div>
        </div>

        <div class="stat-card">
            <div class="stat-number">{{ travel_docs_count or 0 }}</div>
            <div class="stat-label">Travel Docs</div>
            <div class="stat-sublabel">Passports & Visas</div>
        </div>

        <div class="stat-card">
            <div class="stat-number">{{ reservations_count or 0 }}</div>
            <div class="stat-label">Reservations</div>
            <div class="stat-sublabel">Hotels & Flights</div>
        </div>

        <div class="stat-card">
            <div class="stat-number">{{ photos_count + documents_count + videos_count + (other_count or 0) }}</div>
            <div class="stat-label">Media & Docs</div>
            <div class="stat-sublabel">Photos, Videos & Files</div>
        </div>
    </div>

    <!-- Content Grid - Main widget with sidebar -->
    <div class="content-grid">
        <!-- Main Files Widget -->
        <div class="widget">
            <div class="widget-header">
                <div class="header-content">
                    <h3 class="widget-title">
                        <i class="fas fa-folder-open"></i>
                        Trip Documents
                    </h3>
                    <div class="widget-subtitle">
                        Manage and organize your travel files
                        {% if recent_count > 0 %}
                        â€¢ {{ recent_count }} recent uploads
                        {% endif %}
                    </div>
                </div>
                <div class="widget-actions">
                    <div class="view-toggle">
                        <button class="btn btn-sm view-btn active" data-view="cards" title="Card View">
                            <i class="fas fa-th-large"></i>
                        </button>
                        <button class="btn btn-sm view-btn" data-view="list" title="List View">
                            <i class="fas fa-list"></i>
                        </button>
                    </div>
                    <button class="btn btn-primary" onclick="triggerFileSelect()">
                        <i class="fas fa-plus"></i>
                        Upload Files
                    </button>
                </div>
            </div>

            <!-- Filters Bar -->
            <div class="filters-bar">
                <div class="category-filters">
                    <button class="filter-badge active" data-category="all">
                        All <span class="badge-count">{{ files|length if files else 0 }}</span>
                    </button>
                    <button class="filter-badge" data-category="travel">
                        Travel <span class="badge-count">{{ travel_docs_count or 0 }}</span>
                    </button>
                    <button class="filter-badge" data-category="reservations">
                        Bookings <span class="badge-count">{{ reservations_count or 0 }}</span>
                    </button>
                    <button class="filter-badge" data-category="photos">
                        Photos <span class="badge-count">{{ photos_count or 0 }}</span>
                    </button>
                    <button class="filter-badge" data-category="videos">
                        Videos <span class="badge-count">{{ videos_count or 0 }}</span>
                    </button>
                    <button class="filter-badge" data-category="documents">
                        Docs <span class="badge-count">{{ documents_count or 0 }}</span>
                    </button>
                    {% if other_count > 0 %}
                    <button class="filter-badge" data-category="other">
                        Other <span class="badge-count">{{ other_count }}</span>
                    </button>
                    {% endif %}
                </div>

                <div class="search-section">
                    <div class="search-input">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search files..." id="file-search">
                        <button class="clear-search" id="clear-search" style="display: none;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Files Display Area -->
            <div class="files-display">
                {% if files and files|length > 0 %}
                    <div class="files-grid view-cards" id="files-container">
                        {% for file in files %}
                        <div class="file-item" data-category="{{ file.category or 'other' }}" data-file-id="{{ file.id }}">
                            <!-- Card View -->
                            <div class="file-card">
                                <div class="file-preview" data-action="view" data-file-id="{{ file.id }}" data-file-name="{{ file.original_name }}" data-file-type="{{ file.type }}" data-filename="{{ file.filename }}">
                                    {% if file.type == 'image' %}
                                        <img src="{{ url_for('static', filename='uploads/files/' + file.filename) }}"
                                             alt="{{ file.original_name }}" class="file-thumbnail">
                                    {% elif file.type == 'video' %}
                                        <video class="file-thumbnail" muted>
                                            <source src="{{ url_for('static', filename='uploads/files/' + file.filename) }}"
                                                    type="video/{{ file.filename.split('.')[-1] }}">
                                        </video>
                                    {% else %}
                                        <div class="file-icon file-icon-{{ file.type }}">
                                            {% if file.type == 'pdf' %}
                                                <i class="fas fa-file-pdf"></i>
                                            {% elif file.type == 'document' %}
                                                <i class="fas fa-file-word"></i>
                                            {% elif file.type == 'spreadsheet' %}
                                                <i class="fas fa-file-excel"></i>
                                            {% elif file.type == 'video' %}
                                                <i class="fas fa-file-video"></i>
                                            {% else %}
                                                <i class="fas fa-file"></i>
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                    <div class="file-overlay">
                                        <i class="fas fa-eye"></i>
                                    </div>
                                </div>

                                <div class="file-info">
                                    <div class="file-name" title="{{ file.original_name }}">{{ file.original_name }}</div>
                                    <div class="file-meta">
                                        <span class="file-size">{{ file.size or 'Unknown' }}</span>
                                        <span class="file-date">{{ file.created_at.strftime('%b %d') if file.created_at else 'Unknown' }}</span>
                                    </div>
                                    <div class="file-category">
                                        <span class="status-badge status-{{ file.category or 'other' }}">
                                            {{ (file.category or 'other').title() }}
                                        </span>
                                    </div>
                                </div>

                                <div class="file-actions">
                                    <button class="action-btn edit-btn" data-action="edit" data-file-id="{{ file.id }}" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="action-btn" data-action="download" data-filename="{{ file.filename }}" data-original-name="{{ file.original_name }}" title="Download">
                                        <i class="fas fa-download"></i>
                                    </button>
                                    <button class="action-btn delete-btn" data-action="delete" data-file-id="{{ file.id }}" data-file-name="{{ file.original_name }}" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- List View -->
                            <div class="file-row" style="display: none;">
                                <div class="row-icon">
                                    {% if file.type == 'image' %}
                                        <img src="{{ url_for('static', filename='uploads/files/' + file.filename) }}"
                                             alt="{{ file.original_name }}" class="row-thumbnail">
                                    {% elif file.type == 'video' %}
                                        <video class="row-thumbnail" muted>
                                            <source src="{{ url_for('static', filename='uploads/files/' + file.filename) }}"
                                                    type="video/{{ file.filename.split('.')[-1] }}">
                                        </video>
                                    {% else %}
                                        <div class="file-icon-small file-icon-{{ file.type }}">
                                            {% if file.type == 'pdf' %}
                                                <i class="fas fa-file-pdf"></i>
                                            {% elif file.type == 'document' %}
                                                <i class="fas fa-file-word"></i>
                                            {% elif file.type == 'spreadsheet' %}
                                                <i class="fas fa-file-excel"></i>
                                            {% elif file.type == 'video' %}
                                                <i class="fas fa-file-video"></i>
                                            {% else %}
                                                <i class="fas fa-file"></i>
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="row-info" data-action="view" data-file-id="{{ file.id }}" data-file-name="{{ file.original_name }}" data-file-type="{{ file.type }}" data-filename="{{ file.filename }}">
                                    <div class="row-name">{{ file.original_name }}</div>
                                    <div class="row-meta">
                                        <span class="status-badge status-{{ file.category or 'other' }}">
                                            {{ (file.category or 'other').title() }}
                                        </span>
                                        <span class="row-size">{{ file.size or 'Unknown' }}</span>
                                        <span class="row-date">{{ file.created_at.strftime('%b %d, %Y') if file.created_at else 'Unknown' }}</span>
                                    </div>
                                </div>

                                <div class="row-actions">
                                    <button class="task-action-btn edit" data-action="edit" data-file-id="{{ file.id }}" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="task-action-btn" data-action="download" data-filename="{{ file.filename }}" data-original-name="{{ file.original_name }}" title="Download">
                                        <i class="fas fa-download"></i>
                                    </button>
                                    <button class="task-action-btn delete" data-action="delete" data-file-id="{{ file.id }}" data-file-name="{{ file.original_name }}" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="empty-state">
                        <div class="empty-content">
                            <i class="fas fa-folder-open empty-icon"></i>
                            <h3>No files uploaded yet</h3>
                            <p>Upload your first trip document to get started organizing your files</p>
                            <button class="btn btn-primary" onclick="triggerFileSelect()">
                                <i class="fas fa-upload"></i> Upload Files
                            </button>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Sidebar Widgets -->
        <div class="sidebar-widgets">
            <div class="widget">
                <div class="widget-header">
                    <h3 class="widget-title">
                        <i class="fas fa-chart-pie"></i>
                        Storage Overview
                    </h3>
                </div>
                <div class="storage-stats">
                    <div class="storage-item">
                        <div class="storage-label">Used Storage</div>
                        <div class="storage-value">{{ total_size or '0 B' }}</div>
                    </div>
                    {% if recent_count > 0 %}
                    <div class="storage-item">
                        <div class="storage-label">Recent Uploads</div>
                        <div class="storage-value">{{ recent_count }}</div>
                        <div class="storage-sublabel">Last 7 days</div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="widget">
                <div class="widget-header">
                    <h3 class="widget-title">
                        <i class="fas fa-bolt"></i>
                        Quick Actions
                    </h3>
                </div>
                <div class="quick-actions-list">
                    <button class="quick-action-item" onclick="triggerFileSelect()">
                        <i class="fas fa-plus-circle"></i>
                        <span>Upload New Files</span>
                    </button>
                    <button class="quick-action-item" onclick="filterFiles('travel')">
                        <i class="fas fa-passport"></i>
                        <span>View Travel Docs</span>
                    </button>
                    <button class="quick-action-item" onclick="filterFiles('photos')">
                        <i class="fas fa-camera"></i>
                        <span>Browse Photos</span>
                    </button>
                    <button class="quick-action-item" onclick="filterFiles('videos')">
                        <i class="fas fa-video"></i>
                        <span>Browse Videos</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Drag & Drop Overlay -->
    <div class="drop-overlay" id="drop-overlay">
        <div class="drop-content">
            <i class="fas fa-cloud-upload-alt"></i>
            <h3>Drop files to upload</h3>
            <p>Release to add them to your trip documents</p>
        </div>
    </div>
</div>

<!-- Upload Modal -->
<div id="upload-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Upload Files</h3>
            <button class="modal-close" onclick="closeUploadModal()">&times;</button>
        </div>

        <div class="modal-body">
            <div class="upload-zone" id="modal-upload-zone">
                <i class="fas fa-plus-circle upload-icon"></i>
                <h4>Select files to upload</h4>
                <p>Drag & drop files here or click to browse</p>
                <p style="font-size: 12px; color: var(--text-light); margin-top: 8px;">
                    Supports: Documents, Images, Videos (PDF, DOC, JPG, PNG, MOV, MP4, etc.)
                </p>
                <button class="btn btn-secondary" onclick="triggerFileSelect()">
                    <i class="fas fa-folder-open"></i> Browse Files
                </button>
            </div>

            <div class="selected-files" id="selected-files" style="display: none;">
                <h4>Selected Files</h4>
                <div class="files-list" id="files-list"></div>

                <div class="upload-actions">
                    <button class="btn btn-secondary" onclick="clearSelectedFiles()">Clear All</button>
                    <button class="btn btn-primary" onclick="startUpload()" id="upload-btn">
                        <i class="fas fa-upload"></i> Upload <span id="file-count">0</span> Files
                    </button>
                </div>
            </div>

            <div class="upload-progress" id="upload-progress" style="display: none;">
                <div class="progress-info">
                    <span>Uploading files...</span>
                    <span id="progress-text">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit File Modal -->
<div id="edit-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Edit File</h3>
            <button class="modal-close" onclick="closeEditModal()">&times;</button>
        </div>

        <form id="edit-form">
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">File Name</label>
                    <input type="text" class="form-input" id="edit-name" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-select" id="edit-category">
                        <option value="travel">Travel Documents</option>
                        <option value="reservations">Reservations</option>
                        <option value="photos">Photos</option>
                        <option value="videos">Videos</option>
                        <option value="documents">Documents</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-textarea" id="edit-notes" rows="3" placeholder="Add notes about this file..."></textarea>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                <button type="submit" class="btn btn-primary" id="save-btn">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

<!-- File Viewer Modal -->
<div id="viewer-modal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3 class="modal-title" id="viewer-title">File Viewer</h3>
            <div class="viewer-actions">
                <button class="btn btn-secondary btn-sm" id="download-btn-viewer">
                    <i class="fas fa-download"></i> Download
                </button>
                <button class="modal-close" onclick="closeViewerModal()">&times;</button>
            </div>
        </div>

        <div class="modal-body">
            <div id="viewer-content">
                <!-- File content loads here -->
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Confirm Delete</h3>
            <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
        </div>

        <div class="modal-body">
            <p>Are you sure you want to delete <strong id="delete-filename">this file</strong>?</p>
            <p style="color: var(--text-secondary); font-size: 13px; margin-top: 8px;">This action cannot be undone.</p>
        </div>

        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
            <button class="btn btn-danger" onclick="executeDelete()" id="confirm-delete-btn">
                <i class="fas fa-trash"></i> Delete File
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/files.js') }}"></script>
<script>
    window.FILES_DATA = {{ files | tojson if files else [] }};
</script>
{% endblock %}