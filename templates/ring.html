{% extends "base.html" %}

{% block title %}Ring - HERA{% endblock %}
{% block page_title %}Ring Details{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/ring.css') }}">
{% endblock %}

{% block content %}
<div class="ring-container">
    <!-- Ring Showcase -->
    <div class="ring-showcase">
        <div class="ring-gallery">
            <div class="ring-main-image">
                {% if ring_images and ring_images|length > 0 %}
                    <img src="{{ url_for('static', filename='uploads/ring/' + ring_images[0]) }}" alt="Engagement Ring" id="main-ring-image">
                    <div class="image-overlay">
                        <button class="image-action-btn" onclick="openPhotoLightbox('{{ ring_images[0] }}')" data-tooltip="View Full Size">
                            <i class="fas fa-expand"></i>
                        </button>
                        <button class="image-action-btn" onclick="openImageUpload()" data-tooltip="Upload More Images">
                            <i class="fas fa-camera"></i>
                        </button>
                        <button class="image-action-btn" onclick="deleteRingImage('{{ ring_images[0] }}')" data-tooltip="Delete Image">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                {% else %}
                    <div class="ring-image-placeholder" onclick="openImageUpload()">
                        <i class="fas fa-gem"></i>
                        <p>Click to upload ring photos</p>
                        <button class="btn btn-primary">
                            <i class="fas fa-camera"></i>
                            Upload Photos
                        </button>
                    </div>
                {% endif %}
            </div>

            {% if ring_images and ring_images|length > 1 %}
            <div class="ring-thumbnails">
                {% for image in ring_images %}
                <div class="ring-thumbnail {{ 'active' if loop.first else '' }}" onclick="changeMainImage('{{ image }}')">
                    <img src="{{ url_for('static', filename='uploads/ring/' + image) }}" alt="Ring Image {{ loop.index }}">
                    <button class="thumbnail-delete" onclick="deleteRingImage('{{ image }}')" title="Delete">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <div class="ring-details">
            <h2 class="ring-title">
                <span class="editable-text" data-field="stone" data-item-id="ring">{{ ring['Stone(s)'] or 'Custom' }}</span>
                Ring
            </h2>
            <p class="ring-subtitle">
                <span class="editable-text" data-field="metal" data-item-id="ring">{{ ring.Metal or '18k Gold' }}</span> â€¢
                <span class="editable-text" data-field="jeweler" data-item-id="ring">{{ ring.Jeweler or 'Custom Jeweler' }}</span>
            </p>

            <div class="ring-specs">
                <div class="spec-item">
                    <span class="spec-label">Jeweler</span>
                    <span class="spec-value editable-text" data-field="jeweler" data-item-id="ring">{{ ring.Jeweler or 'GWFJ' }}</span>
                </div>

                <div class="spec-item">
                    <span class="spec-label">Metal</span>
                    <span class="spec-value editable-text" data-field="metal" data-item-id="ring">{{ ring.Metal or '18k Yellow Gold' }}</span>
                </div>

                <div class="spec-item">
                    <span class="spec-label">Stone</span>
                    <span class="spec-value editable-text" data-field="stone" data-item-id="ring">{{ ring['Stone(s)'] or '2.98ct Lab Grown Diamond' }}</span>
                </div>

                <div class="spec-item">
                    <span class="spec-label">Ring Style</span>
                    <span class="spec-value editable-text" data-field="style" data-item-id="ring">{{ ring['Ring Style (Inspiration)'] or 'Custom Design' }}</span>
                </div>

                <div class="spec-item">
                    <span class="spec-label">Status</span>
                    <span class="spec-value status-indicator {{ 'status-complete' if ring.Delivered == 'YES, delivered' else 'status-pending' }}">
                        <span class="editable-select" data-field="delivered" data-item-id="ring" data-options="YES, delivered|In Progress|Ordered|Not Started">
                            {{ ring.Delivered or 'In Progress' }}
                        </span>
                    </span>
                </div>

                <div class="spec-item">
                    <span class="spec-label">Design Approved</span>
                    <span class="spec-value editable-select" data-field="design_approved" data-item-id="ring" data-options="YES|NO|Pending">
                        {{ ring['Design Approved'] or 'YES' }}
                    </span>
                </div>

                <div class="spec-item">
                    <span class="spec-label">Order Placed</span>
                    <span class="spec-value editable-select" data-field="order_placed" data-item-id="ring" data-options="Yes|No|Pending">
                        {{ ring['Order Placed'] or 'Yes' }}
                    </span>
                </div>

                <div class="spec-item">
                    <span class="spec-label">Insured</span>
                    <span class="spec-value editable-select" data-field="insured" data-item-id="ring" data-options="Yes|No|Pending">
                        {{ ring.Insured or 'Yes' }}
                    </span>
                </div>

                {% if ring['Insurance Details'] %}
                <div class="spec-item">
                    <span class="spec-label">Insurance Details</span>
                    <span class="spec-value editable-text" data-field="insurance_details" data-item-id="ring">{{ ring['Insurance Details'] }}</span>
                </div>
                {% endif %}

                {% if ring.Engraving %}
                <div class="spec-item">
                    <span class="spec-label">Engraving</span>
                    <span class="spec-value editable-text" data-field="engraving" data-item-id="ring">{{ ring.Engraving }}</span>
                </div>
                {% endif %}
            </div>

            <div class="ring-actions">
                <button class="btn btn-primary" onclick="openRingEditModal()">
                    <i class="fas fa-edit"></i>
                    Edit Details
                </button>
                <button class="btn btn-secondary" onclick="openImageUpload()">
                    <i class="fas fa-camera"></i>
                    Manage Photos
                </button>
                {% if ring['Ring Style (Inspiration)'] %}
                <a href="{{ ring['Ring Style (Inspiration)'] }}" target="_blank" class="btn btn-outline">
                    <i class="fas fa-external-link-alt"></i>
                    View Inspiration
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Ring Progress Timeline -->
    <div class="widget ring-timeline">
        <div class="widget-header">
            <h3 class="widget-title">
                <i class="fas fa-timeline"></i>
                Ring Progress Timeline
            </h3>
            <p class="widget-subtitle">Track your ring from design to delivery</p>
        </div>

        <div class="timeline">
            <div class="timeline-item {{ 'completed' if ring['Design Approved'] == 'YES' else 'pending' }}">
                <div class="timeline-icon">
                    <i class="fas fa-drafting-compass"></i>
                </div>
                <div class="timeline-content">
                    <h4>Design Approved</h4>
                    <p>Ring design finalized and approved</p>
                    <span class="timeline-status">
                        {{ ring['Design Approved'] or 'Pending' }}
                    </span>
                </div>
            </div>

            <div class="timeline-item {{ 'completed' if ring['Order Placed'] == 'Yes' else 'pending' }}">
                <div class="timeline-icon">
                    <i class="fas fa-shopping-cart"></i>
                </div>
                <div class="timeline-content">
                    <h4>Order Placed</h4>
                    <p>Ring ordered with jeweler</p>
                    <span class="timeline-status">
                        {{ ring['Order Placed'] or 'Pending' }}
                    </span>
                </div>
            </div>

            <div class="timeline-item {{ 'completed' if ring.Delivered == 'YES, delivered' else 'pending' }}">
                <div class="timeline-icon">
                    <i class="fas fa-gem"></i>
                </div>
                <div class="timeline-content">
                    <h4>Ring Delivered</h4>
                    <p>Ring completed and delivered</p>
                    <span class="timeline-status">
                        {{ ring.Delivered or 'In Progress' }}
                    </span>
                </div>
            </div>

            <div class="timeline-item {{ 'completed' if ring.Insured == 'Yes' else 'pending' }}">
                <div class="timeline-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="timeline-content">
                    <h4>Insurance</h4>
                    <p>Ring insured and protected</p>
                    <span class="timeline-status">
                        {{ ring.Insured or 'Pending' }}
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden file input for photo uploads -->
<input type="file" id="photo-upload-input" accept="image/*" multiple style="display: none;">

<!-- Photo Upload Modal -->
<div id="photo-upload-modal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3 class="modal-title">Upload Ring Photos</h3>
            <button class="modal-close" onclick="closePhotoUploadModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="upload-drop-zone" id="upload-drop-zone">
                <i class="fas fa-cloud-upload-alt"></i>
                <p>Drag & drop photos here or click to browse</p>
                <button type="button" class="btn btn-primary" onclick="document.getElementById('photo-upload-input').click()">
                    <i class="fas fa-camera"></i>
                    Choose Photos
                </button>
            </div>

            <div class="upload-preview" id="upload-preview" style="display: none;">
                <h4>Photos to Upload</h4>
                <div class="preview-grid" id="preview-grid"></div>
            </div>

            <div class="upload-progress" id="upload-progress" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <p class="progress-text" id="progress-text">Uploading...</p>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closePhotoUploadModal()">Cancel</button>
            <button type="button" class="btn btn-primary" id="upload-photos-btn" onclick="uploadSelectedPhotos()" style="display: none;">
                <i class="fas fa-upload"></i>
                Upload Photos
            </button>
        </div>
    </div>
</div>

<!-- Ring Edit Modal -->
<div id="ring-edit-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Edit Ring Details</h3>
            <button class="modal-close" onclick="closeRingEditModal()">&times;</button>
        </div>
        <form id="ring-edit-form" onsubmit="updateRingDetails(event)">
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Jeweler</label>
                    <input type="text" class="form-input" id="edit-jeweler" value="{{ ring.Jeweler or 'GWFJ' }}">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Metal</label>
                        <input type="text" class="form-input" id="edit-metal" value="{{ ring.Metal or '18k Yellow Gold' }}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Stone(s)</label>
                        <input type="text" class="form-input" id="edit-stone" value="{{ ring['Stone(s)'] or '2.98ct Lab Grown Diamond' }}">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Ring Style (Inspiration Link)</label>
                    <input type="url" class="form-input" id="edit-style" value="{{ ring['Ring Style (Inspiration)'] or '' }}" placeholder="https://...">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Design Approved</label>
                        <select class="form-select" id="edit-design-approved">
                            <option value="YES" {{ 'selected' if ring['Design Approved'] == 'YES' else '' }}>YES</option>
                            <option value="NO" {{ 'selected' if ring['Design Approved'] == 'NO' else '' }}>NO</option>
                            <option value="Pending" {{ 'selected' if ring['Design Approved'] == 'Pending' else '' }}>Pending</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Order Placed</label>
                        <select class="form-select" id="edit-order-placed">
                            <option value="Yes" {{ 'selected' if ring['Order Placed'] == 'Yes' else '' }}>Yes</option>
                            <option value="No" {{ 'selected' if ring['Order Placed'] == 'No' else '' }}>No</option>
                            <option value="Pending" {{ 'selected' if ring['Order Placed'] == 'Pending' else '' }}>Pending</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Delivery Status</label>
                        <select class="form-select" id="edit-delivered">
                            <option value="YES, delivered" {{ 'selected' if ring.Delivered == 'YES, delivered' else '' }}>YES, delivered</option>
                            <option value="In Progress" {{ 'selected' if ring.Delivered == 'In Progress' else '' }}>In Progress</option>
                            <option value="Ordered" {{ 'selected' if ring.Delivered == 'Ordered' else '' }}>Ordered</option>
                            <option value="Not Started" {{ 'selected' if ring.Delivered == 'Not Started' else '' }}>Not Started</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Insured</label>
                        <select class="form-select" id="edit-insured">
                            <option value="Yes" {{ 'selected' if ring.Insured == 'Yes' else '' }}>Yes</option>
                            <option value="No" {{ 'selected' if ring.Insured == 'No' else '' }}>No</option>
                            <option value="Pending" {{ 'selected' if ring.Insured == 'Pending' else '' }}>Pending</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Insurance Details</label>
                    <input type="text" class="form-input" id="edit-insurance-details" value="{{ ring['Insurance Details'] or '' }}" placeholder="Insurance provider and policy details">
                </div>

                <div class="form-group">
                    <label class="form-label">Engraving</label>
                    <input type="text" class="form-input" id="edit-engraving" value="{{ ring.Engraving or '' }}" placeholder="Ring engraving text">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeRingEditModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Photo Lightbox -->
<div id="photo-lightbox" class="lightbox">
    <div class="lightbox-content">
        <button class="lightbox-close" onclick="closeLightbox()">&times;</button>
        <img id="lightbox-image" src="" alt="Ring Photo">
        <div class="lightbox-nav">
            <button class="lightbox-nav-btn" onclick="previousPhoto()">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button class="lightbox-nav-btn" onclick="nextPhoto()">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/ring.js') }}"></script>
<script>
    // Pass Flask data to JavaScript
    window.RING_DATA = {{ ring | tojson }};
    window.RING_IMAGES = {{ ring_images | tojson }};

    // Initialize ring page functionality
    document.addEventListener('DOMContentLoaded', function() {
        initializeRingPage();
    });
</script>
{% endblock %}