{% extends "base.html" %}

{% block title %}Ring - HERA{% endblock %}
{% block page_title %}Ring Details{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/ring.css') }}">
{% endblock %}

{% block content %}
<div class="ring-container">
    <!-- Ring Showcase -->
    <div class="ring-showcase">
        <div class="ring-gallery">
            <div class="ring-main-image">
                {% if ring_images and ring_images|length > 0 %}
                    {% set first_file = ring_images[0] %}
                    {% set file_ext = first_file.split('.')[-1].lower() %}
                    {% if file_ext in ['mov', 'mp4', 'avi', 'mkv', 'webm'] %}
                        <video controls id="main-ring-media" class="ring-media-element">
                            <source src="{{ url_for('static', filename='uploads/ring/' + first_file) }}" type="video/{{ 'mp4' if file_ext == 'mp4' else 'quicktime' if file_ext == 'mov' else file_ext }}">
                            Your browser does not support video playback.
                        </video>
                    {% else %}
                        <img src="{{ url_for('static', filename='uploads/ring/' + first_file) }}" alt="Engagement Ring" id="main-ring-media" class="ring-media-element">
                    {% endif %}
                    <div class="image-overlay">
                        <button class="image-action-btn" onclick="openMediaLightbox('{{ first_file }}')" title="View Full Size">
                            <i class="fas fa-expand"></i>
                        </button>
                        <button class="image-action-btn" onclick="openMediaUpload()" title="Upload More Media">
                            <i class="fas fa-camera"></i>
                        </button>
                        <button class="image-action-btn" onclick="deleteRingMedia('{{ first_file }}')" title="Delete Media">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                {% else %}
                    <div class="ring-image-placeholder" onclick="openMediaUpload()">
                        <i class="fas fa-gem"></i>
                        <p>Click to upload ring photos & videos</p>
                        <button class="btn btn-primary">
                            <i class="fas fa-camera"></i>
                            Upload Media
                        </button>
                    </div>
                {% endif %}
            </div>

            {% if ring_images and ring_images|length > 1 %}
            <div class="ring-thumbnails">
                {% for media_file in ring_images %}
                {% set file_ext = media_file.split('.')[-1].lower() %}
                <div class="ring-thumbnail {{ 'active' if loop.first else '' }}" onclick="changeMainMedia('{{ media_file }}')">
                    {% if file_ext in ['mov', 'mp4', 'avi', 'mkv', 'webm'] %}
                        <video class="thumbnail-video">
                            <source src="{{ url_for('static', filename='uploads/ring/' + media_file) }}" type="video/{{ 'mp4' if file_ext == 'mp4' else 'quicktime' if file_ext == 'mov' else file_ext }}">
                        </video>
                        <div class="video-play-icon">
                            <i class="fas fa-play"></i>
                        </div>
                    {% else %}
                        <img src="{{ url_for('static', filename='uploads/ring/' + media_file) }}" alt="Ring Media {{ loop.index }}">
                    {% endif %}
                    <button class="thumbnail-delete" onclick="event.stopPropagation(); deleteRingMedia('{{ media_file }}')" title="Delete">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <div class="ring-details">
            <h1 class="ring-title">{{ ring.stone or 'Diamond' }} Ring</h1>
            <p class="ring-subtitle">{{ ring.metal or '18k Gold' }} | {{ ring.jeweler or 'Custom Jeweler' }}</p>

            <div class="ring-specs">
                <div class="spec-item">
                    <span class="spec-label">Jeweler</span>
                    <span class="spec-value editable-text" data-field="jeweler">{{ ring.jeweler or 'GWFJ' }}</span>
                </div>
                <div class="spec-item">
                    <span class="spec-label">Metal</span>
                    <span class="spec-value editable-text" data-field="metal">{{ ring.metal or '18k Yellow Gold' }}</span>
                </div>
                <div class="spec-item">
                    <span class="spec-label">Stone(s)</span>
                    <span class="spec-value editable-text" data-field="stone">{{ ring.stone or '2.98ct Lab Grown Diamond' }}</span>
                </div>
                <div class="spec-item">
                    <span class="spec-label">Ring Style</span>
                    <span class="spec-value editable-text" data-field="style_inspiration">{{ ring.style_inspiration or 'Custom Design' }}</span>
                </div>
                <div class="spec-item">
                    <span class="spec-label">Status</span>
                    <span class="spec-value editable-text" data-field="status">{{ ring.status or 'Researching' }}</span>
                </div>
                <div class="spec-item">
                    <span class="spec-label">Cost</span>
                    <span class="spec-value editable-text" data-field="cost">${{ "{:,.0f}".format(ring.cost or 0) }}</span>
                </div>
                <div class="spec-item">
                    <span class="spec-label">Deposit Paid</span>
                    <span class="spec-value editable-text" data-field="deposit_paid">${{ "{:,.0f}".format(ring.deposit_paid or 0) }}</span>
                </div>
                <div class="spec-item">
                    <span class="spec-label">Balance Due</span>
                    <span class="spec-value">${{ "{:,.0f}".format(ring.balance_due or 0) }}</span>
                </div>
                {% if ring.insurance %}
                <div class="spec-item">
                    <span class="spec-label">Insurance</span>
                    <span class="spec-value editable-text" data-field="insurance">{{ ring.insurance }}</span>
                </div>
                {% endif %}
                {% if ring.notes %}
                <div class="spec-item">
                    <span class="spec-label">Notes</span>
                    <span class="spec-value editable-text" data-field="notes">{{ ring.notes }}</span>
                </div>
                {% endif %}
            </div>


            <div class="ring-actions">
                <button class="btn btn-primary" onclick="openMediaUpload()">
                    <i class="fas fa-camera"></i>
                    Add Media
                </button>
                <button class="btn btn-outline" onclick="openRingEditModal()">
                    <i class="fas fa-edit"></i>
                    Edit Details
                </button>
            </div>
        </div>
    </div>

    <!-- Ring Timeline -->
    <div class="ring-timeline">
        <div class="widget-header">
            <h2 class="widget-title">
                <i class="fas fa-clock"></i>
                Ring Progress
            </h2>
            <p class="widget-subtitle">Track the journey from purchase to proposal</p>
        </div>

        <div class="timeline">
            <div class="timeline-item {{ 'completed' if ring.status in ['Designing', 'Ordered', 'Complete'] else 'pending' }}">
                <div class="timeline-icon">
                    <i class="fas fa-drafting-compass"></i>
                </div>
                <div class="timeline-content">
                    <h4>Design Approved</h4>
                    <p>Ring design approved and finalized</p>
                    <span class="timeline-status">
                        {{ 'Complete' if ring.status in ['Designing', 'Ordered', 'Complete'] else 'Pending' }}
                    </span>
                </div>
            </div>

            <div class="timeline-item {{ 'completed' if ring.status in ['Ordered', 'Complete'] else 'pending' }}">
                <div class="timeline-icon">
                    <i class="fas fa-shopping-cart"></i>
                </div>
                <div class="timeline-content">
                    <h4>Order Placed</h4>
                    <p>Ring order placed with deposit</p>
                    <span class="timeline-status">
                        {{ 'Complete' if ring.status in ['Ordered', 'Complete'] else 'Pending' }}
                    </span>
                </div>
            </div>

            {% if ring.status == 'Ordered' %}
            <div class="timeline-item pending">
                <div class="timeline-icon">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <div class="timeline-content">
                    <h4>Estimated Delivery</h4>
                    <p>Expected completion date</p>
                    <span class="timeline-status">
                        In Production
                    </span>
                </div>
            </div>
            {% endif %}

            <div class="timeline-item {{ 'completed' if ring.status == 'Complete' else 'pending' }}">
                <div class="timeline-icon">
                    <i class="fas fa-truck"></i>
                </div>
                <div class="timeline-content">
                    <h4>Ring Delivered</h4>
                    <p>Ring completed and delivered</p>
                    <span class="timeline-status">
                        {{ 'Complete' if ring.status == 'Complete' else 'In Progress' }}
                    </span>
                </div>
            </div>

            <div class="timeline-item {{ 'completed' if ring.insurance else 'pending' }}">
                <div class="timeline-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="timeline-content">
                    <h4>Insurance</h4>
                    <p>Ring insured and protected</p>
                    <span class="timeline-status">
                        {{ ring.insurance if ring.insurance else 'Pending' }}
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden file input for media uploads -->
<input type="file" id="media-upload-input" accept="image/*,video/*" multiple style="display: none;">

<!-- Media Upload Modal -->
<div id="media-upload-modal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3 class="modal-title">Upload Ring Photos & Videos</h3>
            <button class="modal-close" onclick="closeMediaUploadModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="upload-drop-zone" id="upload-drop-zone">
                <i class="fas fa-cloud-upload-alt"></i>
                <p>Drag & drop photos/videos here or click to browse</p>
                <button type="button" class="btn btn-primary" onclick="document.getElementById('media-upload-input').click()">
                    <i class="fas fa-camera"></i>
                    Choose Media
                </button>
            </div>

            <div class="upload-preview" id="upload-preview" style="display: none;">
                <h4>Media to Upload</h4>
                <div class="preview-grid" id="preview-grid"></div>
            </div>

            <div class="upload-progress" id="upload-progress" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <p id="progress-text">Uploading media...</p>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeMediaUploadModal()">Cancel</button>
            <button type="button" class="btn btn-primary" id="upload-media-btn" onclick="uploadSelectedMedia()" style="display: none;">
                <i class="fas fa-upload"></i>
                Upload Media
            </button>
        </div>
    </div>
</div>

<!-- Ring Edit Modal (FIXED STRUCTURE) -->
<div id="ring-edit-modal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3 class="modal-title">Edit Ring Details</h3>
            <button class="modal-close" onclick="closeRingEditModal()">&times;</button>
        </div>
        <!-- The <form> tag now IS the modal-body, making it the scrollable container -->
        <form id="ring-edit-form" class="modal-body" onsubmit="updateRingDetails(event)">
            <div class="form-group">
                <label class="form-label">Jeweler</label>
                <input type="text" class="form-input" id="edit-jeweler" value="{{ ring.jeweler or 'GWFJ' }}">
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Metal</label>
                    <input type="text" class="form-input" id="edit-metal" value="{{ ring.metal or '18k Yellow Gold' }}">
                </div>
                <div class="form-group">
                    <label class="form-label">Stone(s)</label>
                    <input type="text" class="form-input" id="edit-stones" value="{{ ring.stone or '2.98ct Lab Grown Diamond' }}">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Ring Style (Inspiration)</label>
                <input type="url" class="form-input" id="edit-style" value="{{ ring.style_inspiration or '' }}" placeholder="https://...">
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="edit-status">
                        <option value="Researching" {{ 'selected' if ring.status == 'Researching' else '' }}>Researching</option>
                        <option value="Designing" {{ 'selected' if ring.status == 'Designing' else '' }}>Designing</option>
                        <option value="Ordered" {{ 'selected' if ring.status == 'Ordered' else '' }}>Ordered</option>
                        <option value="Complete" {{ 'selected' if ring.status == 'Complete' else '' }}>Complete</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Cost</label>
                    <input type="number" class="form-input" id="edit-cost" value="{{ ring.cost or 0 }}" placeholder="Total cost">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Deposit Paid</label>
                    <input type="number" class="form-input" id="edit-deposit" value="{{ ring.deposit_paid or 0 }}" placeholder="Deposit amount">
                </div>
                <div class="form-group">
                    <label class="form-label">Balance Due</label>
                    <input type="text" class="form-input" value="${{ '{:,.0f}'.format(ring.balance_due or 0) }}" readonly disabled>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Insurance Details</label>
                <input type="text" class="form-input" id="edit-insurance-details" value="{{ ring.insurance or '' }}" placeholder="Insurance provider and policy details">
            </div>

            <div class="form-group">
                <label class="form-label">Notes</label>
                <textarea class="form-input" id="edit-notes" rows="3" placeholder="Additional notes">{{ ring.notes or '' }}</textarea>
            </div>
        </form>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeRingEditModal()">Cancel</button>
            <!-- The 'form' attribute links this button to the form with id="ring-edit-form" -->
            <button type="submit" form="ring-edit-form" class="btn btn-primary">
                <i class="fas fa-save"></i>
                Save Changes
            </button>
        </div>
    </div>
</div>


<!-- Media Lightbox -->
<div id="media-lightbox" class="lightbox">
    <div class="lightbox-content">
        <button class="lightbox-close" onclick="closeLightbox()">&times;</button>
        <div id="lightbox-media-container">
            <img id="lightbox-image" src="" alt="Ring Media" style="display: none;">
            <video id="lightbox-video" controls style="display: none;">
                <source src="" type="video/mp4">
                Your browser does not support video playback.
            </video>
        </div>
        {% if ring_images and ring_images|length > 1 %}
        <div class="lightbox-nav">
            <button class="lightbox-nav-btn" onclick="previousMedia()">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button class="lightbox-nav-btn" onclick="nextMedia()">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/ring.js') }}"></script>
<script>
    // Pass Flask data to JavaScript
    window.RING_DATA = {{ ring | tojson }};
    window.RING_IMAGES = {{ ring_images | tojson }};

    // Initialize ring page functionality
    document.addEventListener('DOMContentLoaded', function() {
        initializeRingPage();
    });
</script>
{% endblock %}