{% extends "base.html" %}

{% block title %}Ring - HERA{% endblock %}
{% block page_title %}Ring Details{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/ring.css') }}">
{% endblock %}

{% block content %}
<div class="ring-container">
    <!-- Ring Showcase -->
    <div class="ring-showcase">
        <div class="ring-gallery">
            <div class="ring-main-image">
                {% if ring_images and ring_images|length > 0 %}
                    <img src="{{ url_for('static', filename='uploads/ring/' + ring_images[0]) }}" alt="Engagement Ring" id="main-ring-image">
                    <div class="image-overlay">
                        <button class="image-action-btn" onclick="openPhotoLightbox('{{ ring_images[0] }}')" title="View Full Size">
                            <i class="fas fa-expand"></i>
                        </button>
                        <button class="image-action-btn" onclick="openImageUpload()" title="Upload More Images">
                            <i class="fas fa-camera"></i>
                        </button>
                        <button class="image-action-btn" onclick="deleteRingImage('{{ ring_images[0] }}')" title="Delete Image">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                {% else %}
                    <div class="ring-image-placeholder" onclick="openImageUpload()">
                        <i class="fas fa-gem"></i>
                        <p>Click to upload ring photos</p>
                        <button class="btn btn-primary">
                            <i class="fas fa-camera"></i>
                            Upload Photos
                        </button>
                    </div>
                {% endif %}
            </div>

            {% if ring_images and ring_images|length > 1 %}
            <div class="ring-thumbnails">
                {% for image in ring_images %}
                <div class="ring-thumbnail {{ 'active' if loop.first else '' }}" onclick="changeMainImage('{{ image }}')">
                    <img src="{{ url_for('static', filename='uploads/ring/' + image) }}" alt="Ring Image {{ loop.index }}">
                    <button class="thumbnail-delete" onclick="deleteRingImage('{{ image }}')" title="Delete">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <div class="ring-details">
            <h1 class="ring-title">{{ ring['Stone(s)'] or 'Diamond' }} Ring</h1>
            <p class="ring-subtitle">{{ ring.Metal or '18k Gold' }} â€¢ {{ ring.Jeweler or 'Custom Jeweler' }}</p>

            <div class="ring-specs">
                <div class="spec-item">
                    <span class="spec-label">Jeweler</span>
                    <span class="spec-value editable-text" data-field="Jeweler">{{ ring.Jeweler or 'GWFJ' }}</span>
                </div>
                <div class="spec-item">
                    <span class="spec-label">Metal</span>
                    <span class="spec-value editable-text" data-field="Metal">{{ ring.Metal or '18k Yellow Gold' }}</span>
                </div>
                <div class="spec-item">
                    <span class="spec-label">Stone(s)</span>
                    <span class="spec-value editable-text" data-field="Stone(s)">{{ ring['Stone(s)'] or '2.98ct Lab Grown Diamond' }}</span>
                </div>
                <div class="spec-item">
                    <span class="spec-label">Ring Style</span>
                    <span class="spec-value editable-text" data-field="Ring Style (Inspiration)">{{ ring['Ring Style (Inspiration)'] or 'Custom Design' }}</span>
                </div>
                <div class="spec-item">
                    <span class="spec-label">Design Approved</span>
                    <span class="spec-value editable-text" data-field="Design Approved">{{ ring['Design Approved'] or 'Pending' }}</span>
                </div>
                <div class="spec-item">
                    <span class="spec-label">Order Placed</span>
                    <span class="spec-value editable-text" data-field="Order Placed">{{ ring['Order Placed'] or 'Pending' }}</span>
                </div>
                <div class="spec-item">
                    <span class="spec-label">Delivered</span>
                    <span class="spec-value editable-text" data-field="Delivered">{{ ring.Delivered or 'In Progress' }}</span>
                </div>
                <div class="spec-item">
                    <span class="spec-label">Insured</span>
                    <span class="spec-value editable-text" data-field="Insured">{{ ring.Insured or 'Pending' }}</span>
                </div>
                {% if ring['Insurance Details'] %}
                <div class="spec-item">
                    <span class="spec-label">Insurance Details</span>
                    <span class="spec-value editable-text" data-field="Insurance Details">{{ ring['Insurance Details'] }}</span>
                </div>
                {% endif %}
                {% if ring.Engraving %}
                <div class="spec-item">
                    <span class="spec-label">Engraving</span>
                    <span class="spec-value editable-text" data-field="Engraving">{{ ring.Engraving }}</span>
                </div>
                {% endif %}
            </div>

            <div class="ring-actions">
                <button class="btn btn-primary" onclick="openRingEditModal()">
                    <i class="fas fa-edit"></i>
                    Edit Details
                </button>
                <button class="btn btn-secondary" onclick="openImageUpload()">
                    <i class="fas fa-camera"></i>
                    Add Photos
                </button>
                {% if ring.Insured != 'Yes' %}
                <button class="btn btn-outline" onclick="updateInsuranceStatus()">
                    <i class="fas fa-shield-alt"></i>
                    Mark Insured
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Ring Timeline -->
    <div class="ring-timeline">
        <div class="widget-header">
            <h2 class="widget-title">
                <i class="fas fa-clock"></i>
                Ring Progress
            </h2>
            <p class="widget-subtitle">Track the journey from purchase to proposal</p>
        </div>

        <div class="timeline">
            <div class="timeline-item {{ 'completed' if 'YES' in (ring['Design Approved'] or '') else 'pending' }}">
                <div class="timeline-icon">
                    <i class="fas fa-drafting-compass"></i>
                </div>
                <div class="timeline-content">
                    <h4>Design Approved</h4>
                    <p>Ring design approved and finalized</p>
                    <span class="timeline-status">
                        {{ ring['Design Approved'] or 'Pending' }}
                    </span>
                </div>
            </div>

            <div class="timeline-item {{ 'completed' if 'Yes' in (ring['Order Placed'] or '') else 'pending' }}">
                <div class="timeline-icon">
                    <i class="fas fa-shopping-cart"></i>
                </div>
                <div class="timeline-content">
                    <h4>Order Placed</h4>
                    <p>Ring order placed with deposit</p>
                    <span class="timeline-status">
                        {{ ring['Order Placed'] or 'Pending' }}
                    </span>
                </div>
            </div>

            {% if ring['Estimated Delivery'] %}
            <div class="timeline-item pending">
                <div class="timeline-icon">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <div class="timeline-content">
                    <h4>Estimated Delivery</h4>
                    <p>Expected completion date</p>
                    <span class="timeline-status">
                        {{ ring['Estimated Delivery'] }}
                    </span>
                </div>
            </div>
            {% endif %}

            <div class="timeline-item {{ 'completed' if 'YES' in (ring.Delivered or '') else 'pending' }}">
                <div class="timeline-icon">
                    <i class="fas fa-truck"></i>
                </div>
                <div class="timeline-content">
                    <h4>Ring Delivered</h4>
                    <p>Ring completed and delivered</p>
                    <span class="timeline-status">
                        {{ ring.Delivered or 'In Progress' }}
                    </span>
                </div>
            </div>

            <div class="timeline-item {{ 'completed' if ring.Insured == 'Yes' else 'pending' }}">
                <div class="timeline-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="timeline-content">
                    <h4>Insurance</h4>
                    <p>Ring insured and protected</p>
                    <span class="timeline-status">
                        {{ ring.Insured or 'Pending' }}
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden file input for photo uploads -->
<input type="file" id="photo-upload-input" accept="image/*" multiple style="display: none;">

<!-- Photo Upload Modal -->
<div id="photo-upload-modal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3 class="modal-title">Upload Ring Photos</h3>
            <button class="modal-close" onclick="closePhotoUploadModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="upload-drop-zone" id="upload-drop-zone">
                <i class="fas fa-cloud-upload-alt"></i>
                <p>Drag & drop photos here or click to browse</p>
                <button type="button" class="btn btn-primary" onclick="document.getElementById('photo-upload-input').click()">
                    <i class="fas fa-camera"></i>
                    Choose Photos
                </button>
            </div>

            <div class="upload-preview" id="upload-preview" style="display: none;">
                <h4>Photos to Upload</h4>
                <div class="preview-grid" id="preview-grid"></div>
            </div>

            <div class="upload-progress" id="upload-progress" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <p id="progress-text">Uploading photos...</p>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closePhotoUploadModal()">Cancel</button>
            <button type="button" class="btn btn-primary" id="upload-photos-btn" onclick="uploadSelectedPhotos()" style="display: none;">
                <i class="fas fa-upload"></i>
                Upload Photos
            </button>
        </div>
    </div>
</div>

<!-- Ring Edit Modal (FIXED STRUCTURE) -->
<div id="ring-edit-modal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3 class="modal-title">Edit Ring Details</h3>
            <button class="modal-close" onclick="closeRingEditModal()">&times;</button>
        </div>
        <!-- The <form> tag now IS the modal-body, making it the scrollable container -->
        <form id="ring-edit-form" class="modal-body" onsubmit="updateRingDetails(event)">
            <div class="form-group">
                <label class="form-label">Jeweler</label>
                <input type="text" class="form-input" id="edit-jeweler" value="{{ ring.Jeweler or 'GWFJ' }}">
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Metal</label>
                    <input type="text" class="form-input" id="edit-metal" value="{{ ring.Metal or '18k Yellow Gold' }}">
                </div>
                <div class="form-group">
                    <label class="form-label">Stone(s)</label>
                    <input type="text" class="form-input" id="edit-stones" value="{{ ring['Stone(s)'] or '2.98ct Lab Grown Diamond' }}">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Ring Style (Inspiration)</label>
                <input type="url" class="form-input" id="edit-style" value="{{ ring['Ring Style (Inspiration)'] or '' }}" placeholder="https://...">
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Design Approved</label>
                    <select class="form-select" id="edit-design-approved">
                        <option value="YES, 50% deposit placed" {{ 'selected' if 'YES' in (ring['Design Approved'] or '') else '' }}>YES, 50% deposit placed</option>
                        <option value="NO" {{ 'selected' if ring['Design Approved'] == 'NO' else '' }}>NO</option>
                        <option value="Pending" {{ 'selected' if ring['Design Approved'] == 'Pending' else '' }}>Pending</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Order Placed</label>
                    <select class="form-select" id="edit-order-placed">
                        <option value="Yes, 50% deposit placed" {{ 'selected' if 'Yes' in (ring['Order Placed'] or '') else '' }}>Yes, 50% deposit placed</option>
                        <option value="No" {{ 'selected' if ring['Order Placed'] == 'No' else '' }}>No</option>
                        <option value="Pending" {{ 'selected' if ring['Order Placed'] == 'Pending' else '' }}>Pending</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Delivered</label>
                    <select class="form-select" id="edit-delivered">
                        <option value="YES, delivered" {{ 'selected' if 'YES' in (ring.Delivered or '') else '' }}>YES, delivered</option>
                        <option value="In Progress" {{ 'selected' if ring.Delivered == 'In Progress' else '' }}>In Progress</option>
                        <option value="Ordered" {{ 'selected' if ring.Delivered == 'Ordered' else '' }}>Ordered</option>
                        <option value="Not Started" {{ 'selected' if ring.Delivered == 'Not Started' else '' }}>Not Started</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Insured</label>
                    <select class="form-select" id="edit-insured">
                        <option value="Yes" {{ 'selected' if ring.Insured == 'Yes' else '' }}>Yes</option>
                        <option value="No" {{ 'selected' if ring.Insured == 'No' else '' }}>No</option>
                        <option value="Pending" {{ 'selected' if ring.Insured == 'Pending' else '' }}>Pending</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Insurance Details</label>
                <input type="text" class="form-input" id="edit-insurance-details" value="{{ ring['Insurance Details'] or '' }}" placeholder="Insurance provider and policy details">
            </div>

            <div class="form-group">
                <label class="form-label">Engraving</label>
                <input type="text" class="form-input" id="edit-engraving" value="{{ ring.Engraving or '' }}" placeholder="Ring engraving text">
            </div>

            <div class="form-group">
                <label class="form-label">Estimated Delivery</label>
                <input type="text" class="form-input" id="edit-estimated-delivery" value="{{ ring['Estimated Delivery'] or '' }}" placeholder="Estimated delivery date">
            </div>
        </form>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeRingEditModal()">Cancel</button>
            <!-- The 'form' attribute links this button to the form with id="ring-edit-form" -->
            <button type="submit" form="ring-edit-form" class="btn btn-primary">
                <i class="fas fa-save"></i>
                Save Changes
            </button>
        </div>
    </div>
</div>


<!-- Photo Lightbox -->
<div id="photo-lightbox" class="lightbox">
    <div class="lightbox-content">
        <button class="lightbox-close" onclick="closeLightbox()">&times;</button>
        <img id="lightbox-image" src="" alt="Ring Photo">
        {% if ring_images and ring_images|length > 1 %}
        <div class="lightbox-nav">
            <button class="lightbox-nav-btn" onclick="previousPhoto()">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button class="lightbox-nav-btn" onclick="nextPhoto()">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/ring.js') }}"></script>
<script>
    // Pass Flask data to JavaScript
    window.RING_DATA = {{ ring | tojson }};
    window.RING_IMAGES = {{ ring_images | tojson }};

    // Initialize ring page functionality
    document.addEventListener('DOMContentLoaded', function() {
        initializeRingPage();
    });
</script>
{% endblock %}